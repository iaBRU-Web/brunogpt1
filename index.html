<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>BRU Multi-AI Chat (BRU-GPT5)</title>
</head>
<body>
  <div class="container">
    <!-- Sidebar -->
    <div class="sidebar">
      <div class="sidebar-header">
        <div class="sidebar-title">BRU Multi-AI</div>
        <button class="theme-toggle" id="themeToggle">üåô</button>
              <div class="guidance-panel">
        <div class="guidance-title">üí° Important Information</div>
        <div class="guidance-content">
          <div class="tip">‚úÖ <strong>Only Groq models are working</strong> - Use LLaMA 3.3 70B</div>
          <div class="tip">üîÑ Not responding? Press <strong>Ctrl + Shift + R</strong></div>
          <div class="tip">‚ö° Groq is fastest and most reliable</div>
          <div class="tip">‚úèÔ∏è Right-click any chat to rename it</div>
        </div>
      </div>

      </div>
      
      <!-- Cloud Sync Section -->
      <div class="email-section">
        <div class="email-toggle" id="emailToggle">
          <span class="email-toggle-icon">‚òÅÔ∏è</span>
          <span class="email-toggle-text">Cloud Sync</span>
          <span class="mode-badge guest" id="modeBadge">Guest</span>
        </div>
        <div class="email-input-area" id="emailInputArea">
          <input 
            type="email" 
            class="email-input" 
            id="userEmail" 
            placeholder="your@email.com"
          >
          <div class="sync-status" id="syncStatus">
            <span>üíæ</span>
            <span>Enter email to sync across devices</span>
          </div>
        </div>
      </div>
      
      <button class="new-chat-btn" id="newChatBtn">+ New Chat</button>
      <button class="image-gen-btn" id="imageGenBtn">üé® AI Image Studio</button>
      
      <div class="search-box">
        <input type="text" placeholder="Search chats..." id="searchInput">
      </div>
      
      <div class="chat-list" id="chatList">
        <!-- Chat history will be populated here -->
      </div>
      
      <!-- Guidance Panel -->
      
      <div class="footer-info">
        <div class="creator-info">Created by <strong>INEZA AIME BRUNO</strong></div>
        <div class="company-info">BRU Companies Limited</div>
        <div class="thanks-info">Special thanks to <strong>NSORO EMMANUEL</strong></div>
      </div>
    </div>

    <!-- Main Chat Area -->
    <div class="main-chat" id="mainChat">
      <div class="chat-header-container">
        <div class="chat-header" id="chatHeader">New Chat</div>
        <button class="rename-chat-btn" id="renameChatBtn" title="Rename chat">‚úèÔ∏è</button>
      </div>
      
      <div class="messages-container" id="messagesContainer">
        <!-- Messages will be populated here -->
      </div>
      
      <!-- Bottom Disclaimer -->
      <div class="disclaimer-bar">
        <span class="disclaimer-text">‚ö†Ô∏è BRU-MULTI-AI (BRU-GPT5) can make mistakes. Please double check important information.</span>
      </div>
      
      <div class="input-area">
        <div class="input-wrapper">
          <button class="attach-btn" id="attachBtn" title="Attach file">üìé</button>
          <input type="file" id="fileInput" accept="image/*,.pdf,.doc,.docx,.txt" style="display: none;">
          <textarea 
            id="messageInput" 
            placeholder="Ask BRUNO-GPT5 Anything... Type your message... (Enter to send, Shift+Enter for new line)"
            rows="1"
          ></textarea>
          <select class="model-selector" id="modelSelector">
            <optgroup label="DeepSeek (Smart)">
              <option value="deepseek-1">DeepSeek Chat #1(not working)</option>
              <option value="deepseek-2">DeepSeek Chat #2(not working)</option>
            </optgroup>
            <optgroup label="Groq (Fast & Free)">
              <option value="groq-1">Groq - LLaMA 3.3 70B #1</option>
              <option value="groq-2">Groq - LLaMA 3.3 70B #2</option>
              <option value="groq-3">Groq - LLaMA 3.3 70B #3</option>
              <option value="groq-4">Groq - LLaMA 3.3 70B #4</option>
            </optgroup>
            <optgroup label="OpenRouter (Variety)">
              <option value="openrouter-1">OpenRouter - LLaMA 3.1 8B #1(not working)</option>
              <option value="openrouter-2">OpenRouter - LLaMA 3.1 8B #2(not working)</option>
              <option value="openrouter-3">OpenRouter - LLaMA 3.1 8B #3(not working)</option>
            </optgroup>
            <optgroup label="OpenAI (Premium)">
              <option value="openai-1">OpenAI - GPT-4o Mini #1(not working)</option>
              <option value="openai-2">OpenAI - GPT-4o Mini #2(not working)</option>
              <option value="openai-3">OpenAI - GPT-4o Mini #3(not working)</option>
            </optgroup>
          </select>
          <button class="send-btn" id="sendBtn">‚Üë</button>
        </div>
        <div class="attached-file" id="attachedFile" style="display: none;">
          <span class="file-info" id="fileInfo"></span>
          <button class="remove-file-btn" id="removeFileBtn">‚úï</button>
        </div>
      </div>
    </div>

    <!-- AI Image Studio Panel -->
    <div class="image-studio" id="imageStudio">
      <div class="studio-header">
        <h2>üé® AI Image Studio</h2>
        <button class="close-studio-btn" id="closeStudioBtn">‚úï</button>
      </div>
      
      <div class="studio-content">
        <div class="studio-tabs">
          <button class="tab-btn active" data-tab="generate">Generate</button>
          <button class="tab-btn" data-tab="transform">Transform</button>
        </div>

        <!-- Generate Tab -->
        <div class="tab-content active" id="generateTab">
          <div class="input-group">
            <label>Text Prompt</label>
            <textarea 
              id="imagePrompt" 
              placeholder="Describe the image you want to create..."
              rows="4"
            ></textarea>
          </div>

          <div class="input-group">
            <label>Style</label>
            <select id="imageStyle">
              <option value="photorealistic">Photorealistic</option>
              <option value="artistic">Artistic</option>
              <option value="anime">Anime</option>
              <option value="oil-painting">Oil Painting</option>
              <option value="watercolor">Watercolor</option>
              <option value="sketch">Pencil Sketch</option>
              <option value="cyberpunk">Cyberpunk</option>
              <option value="fantasy">Fantasy</option>
            </select>
          </div>

          <div class="input-group">
            <label>Platform</label>
            <select id="imagePlatform">
              <option value="stable-diffusion">Stable Diffusion</option>
              <option value="deepdream">Deep Dream Generator</option>
              <option value="artbreeder">Artbreeder</option>
            </select>
          </div>

          <button class="generate-btn" id="generateImageBtn">Generate Image</button>
        </div>

        <!-- Transform Tab -->
        <div class="tab-content" id="transformTab">
          <div class="upload-area" id="uploadArea">
            <div class="upload-icon">üì∏</div>
            <p>Drop an image here or click to upload</p>
            <input type="file" id="transformImageInput" accept="image/*" style="display: none;">
          </div>

          <div class="preview-area" id="previewArea" style="display: none;">
            <img id="previewImage" alt="Preview">
            <button class="remove-preview-btn" id="removePreviewBtn">‚úï</button>
          </div>

          <div class="input-group">
            <label>Transform Style</label>
            <select id="transformStyle">
              <option value="van-gogh">Van Gogh</option>
              <option value="picasso">Picasso</option>
              <option value="monet">Monet</option>
              <option value="dream">Deep Dream</option>
              <option value="cartoon">Cartoon</option>
              <option value="pop-art">Pop Art</option>
            </select>
          </div>

          <div class="input-group">
            <label>Platform</label>
            <select id="transformPlatform">
              <option value="prisma">Prisma AI</option>
              <option value="deepdream">Deep Dream Generator</option>
              <option value="artbreeder">Artbreeder</option>
            </select>
          </div>

          <button class="generate-btn" id="transformImageBtn" disabled>Transform Image</button>
        </div>

        <!-- Results Area -->
        <div class="results-area" id="resultsArea" style="display: none;">
          <h3>Generated Result</h3>
          <div class="result-image-container">
            <img id="resultImage" alt="Generated Image">
          </div>
          <div class="result-actions">
            <button class="action-btn" id="downloadResultBtn">üíæ Download</button>
            <button class="action-btn" id="insertChatBtn">üí¨ Insert to Chat</button>
            <button class="action-btn" id="newGenerationBtn">üîÑ New Generation</button>
          </div>
        </div>

        <!-- Platform Links -->
        <div class="platform-links">
          <h4>External AI Image Platforms</h4>
          <div class="link-grid">
            <a href="https://deepdreamgenerator.com/" target="_blank" class="platform-link">
              <span>üåÄ</span> Deep Dream Generator
            </a>
            <a href="https://www.artbreeder.com/" target="_blank" class="platform-link">
              <span>üé®</span> Artbreeder
            </a>
            <a href="https://prisma-ai.com/" target="_blank" class="platform-link">
              <span>‚ú®</span> Prisma AI
            </a>
            <a href="https://stablediffusion.com/" target="_blank" class="platform-link">
              <span>üöÄ</span> Stable Diffusion
            </a>
          </div>
        </div>

        <!-- Studio Footer -->
        <div class="studio-footer">
          <div class="studio-thanks">Special thanks to <strong>NSORO EMMANUEL</strong></div>
        </div>
      </div>
    </div>

    <!-- Rename Modal -->
    <div class="modal" id="renameModal" style="display: none;">
      <div class="modal-content">
        <h3>Rename Chat</h3>
        <input type="text" id="renameInput" placeholder="Enter new chat name..." maxlength="50">
        <div class="modal-buttons">
          <button class="modal-btn cancel-btn" id="cancelRenameBtn">Cancel</button>
          <button class="modal-btn save-btn" id="saveRenameBtn">Save</button>
        </div>
      </div>
    </div>
  </div>

  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --bg-primary: #ffffff;
      --bg-secondary: #f7f7f7;
      --bg-tertiary: #eeeeee;
      --text-primary: #000000;
      --text-secondary: #666666;
      --border-color: #e0e0e0;
      --hover-bg: #f0f0f0;
      --input-bg: #ffffff;
      --shadow: rgba(0, 0, 0, 0.1);
      --danger: #dc3545;
      --accent: #0066cc;
      --code-bg: #f6f8fa;
      --code-border: #d0d7de;
      --success: #28a745;
      --purple: #8b5cf6;
      --orange: #f59e0b;
      --warning: #ffc107;
    }

    [data-theme="dark"] {
      --bg-primary: #1a1a1a;
      --bg-secondary: #2d2d2d;
      --bg-tertiary: #3a3a3a;
      --text-primary: #ffffff;
      --text-secondary: #b0b0b0;
      --border-color: #404040;
      --hover-bg: #333333;
      --input-bg: #2d2d2d;
      --shadow: rgba(255, 255, 255, 0.1);
      --danger: #ff4d4d;
      --accent: #4d94ff;
      --code-bg: #0d1117;
      --code-border: #30363d;
      --success: #3fb950;
      --purple: #a78bfa;
      --orange: #fbbf24;
      --warning: #ffd966;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
      height: 100vh;
      overflow: hidden;
      transition: background 0.3s, color 0.3s;
    }

    .container {
      display: flex;
      height: 100vh;
      position: relative;
    }

    /* Sidebar */
    .sidebar {
      width: 280px;
      background: var(--bg-secondary);
      border-right: 1px solid var(--border-color);
      display: flex;
      flex-direction: column;
      transition: all 0.3s;
      z-index: 100;
    }

    .sidebar-header {
      padding: 20px;
      border-bottom: 1px solid var(--border-color);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .sidebar-title {
      font-size: 18px;
      font-weight: 600;
    }

    .theme-toggle {
      background: none;
      border: none;
      cursor: pointer;
      font-size: 20px;
      padding: 8px;
      border-radius: 8px;
      transition: background 0.2s;
    }

    .theme-toggle:hover {
      background: var(--hover-bg);
    }

    .new-chat-btn, .image-gen-btn {
      margin: 8px 16px;
      padding: 12px;
      background: var(--bg-primary);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      color: var(--text-primary);
      transition: all 0.2s;
      font-weight: 500;
    }

    .new-chat-btn:hover, .image-gen-btn:hover {
      background: var(--hover-bg);
      transform: translateY(-1px);
    }

    .image-gen-btn {
      background: linear-gradient(135deg, var(--purple), var(--accent));
      color: white;
      border: none;
      margin-top: 0;
    }

    .image-gen-btn:hover {
      opacity: 0.9;
    }

    .search-box {
      margin: 0 16px 16px;
      position: relative;
    }

    .search-box input {
      width: 100%;
      padding: 10px 12px;
      background: var(--input-bg);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      color: var(--text-primary);
      font-size: 14px;
      outline: none;
      transition: all 0.2s;
    }

    .search-box input:focus {
      border-color: var(--text-secondary);
      box-shadow: 0 0 0 3px var(--shadow);
    }

    /* Email Cloud Sync Section */
    .email-section {
      padding: 12px;
      background: var(--bg-secondary);
      border-bottom: 1px solid var(--border-color);
      margin-bottom: 8px;
    }
    
    .email-toggle {
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
      padding: 8px;
      border-radius: 8px;
      transition: background 0.2s;
    }
    
    .email-toggle:hover {
      background: var(--hover-bg);
    }
    
    .email-toggle-icon {
      font-size: 18px;
    }
    
    .email-toggle-text {
      flex: 1;
      font-size: 13px;
      color: var(--text-secondary);
      font-weight: 500;
    }
    
    .mode-badge {
      font-size: 10px;
      padding: 3px 8px;
      border-radius: 12px;
      background: var(--accent);
      color: white;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .mode-badge.guest {
      background: #6b7280;
    }
    
    .email-input-area {
      margin-top: 8px;
      display: none;
      animation: slideDown 0.2s ease-out;
    }
    
    @keyframes slideDown {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    .email-input-area.active {
      display: block;
    }
    
    .email-input {
      width: 100%;
      padding: 8px 12px;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      font-size: 13px;
      background: var(--input-bg);
      color: var(--text-primary);
      margin-bottom: 6px;
      outline: none;
      transition: all 0.2s;
    }
    
    .email-input:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 3px var(--shadow);
    }
    
    .sync-status {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 11px;
      color: var(--text-secondary);
      padding: 4px 8px;
      background: var(--bg-tertiary);
      border-radius: 6px;
    }
    
    .sync-status.synced { 
      color: var(--success); 
      background: rgba(40, 167, 69, 0.1);
    }
    
    .sync-status.syncing { 
      color: var(--orange); 
      background: rgba(245, 158, 11, 0.1);
    }
    
    .sync-status.error { 
      color: var(--danger);
      background: rgba(220, 53, 69, 0.1);
    }

    .chat-list {
      flex: 1;
      overflow-y: auto;
      padding: 0 12px;
    }

    .chat-item {
      padding: 12px;
      margin-bottom: 4px;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
      font-size: 14px;
      color: var(--text-primary);
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      position: relative;
    }

    .chat-item:hover {
      background: var(--hover-bg);
    }

    .chat-item.active {
      background: var(--bg-tertiary);
      font-weight: 500;
    }

    .chat-item-title {
      flex: 1;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .chat-item-actions {
      display: flex;
      gap: 4px;
      opacity: 0;
      transition: opacity 0.2s;
    }

    .chat-item:hover .chat-item-actions {
      opacity: 1;
    }

    .rename-chat-item-btn, .delete-chat-btn {
      background: none;
      border: none;
      cursor: pointer;
      font-size: 14px;
      padding: 4px 6px;
      border-radius: 4px;
      color: var(--text-secondary);
      transition: all 0.2s;
      flex-shrink: 0;
    }

    .rename-chat-item-btn:hover {
      background: var(--accent);
      color: white;
    }

    .delete-chat-btn:hover {
      background: var(--danger);
      color: white;
    }

    /* Guidance Panel */
    .guidance-panel {
      padding: 12px 16px;
      margin: 0 12px 12px;
      background: var(--bg-tertiary);
      border-radius: 8px;
      border: 1px solid var(--border-color);
    }

    .guidance-title {
      font-size: 12px;
      font-weight: 600;
      margin-bottom: 8px;
      color: var(--text-primary);
    }

    .guidance-content {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .tip {
      font-size: 11px;
      color: var(--text-secondary);
      line-height: 1.4;
    }

    .tip strong {
      color: var(--accent);
      font-weight: 600;
    }

    /* Footer Info */
    .footer-info {
      padding: 16px;
      border-top: 1px solid var(--border-color);
      text-align: center;
      background: var(--bg-secondary);
    }

    .creator-info {
      font-size: 11px;
      color: var(--text-secondary);
      margin-bottom: 6px;
    }

    .creator-info strong {
      color: var(--accent);
      font-weight: 700;
    }

    .company-info {
      font-size: 10px;
      color: var(--text-secondary);
      opacity: 0.8;
      margin-bottom: 6px;
    }

    .thanks-info {
      font-size: 10px;
      color: var(--text-secondary);
      margin-top: 8px;
      padding-top: 8px;
      border-top: 1px solid var(--border-color);
    }

    .thanks-info strong {
      color: var(--purple);
      font-weight: 700;
    }

    /* Main Chat Area */
    .main-chat {
      flex: 1;
      display: flex;
      flex-direction: column;
      background: var(--bg-primary);
      transition: all 0.3s;
    }

    .main-chat.studio-open {
      margin-right: 450px;
    }

    .chat-header-container {
      padding: 20px;
      border-bottom: 1px solid var(--border-color);
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
    }

    .chat-header {
      font-size: 16px;
      font-weight: 600;
      flex: 1;
    }

    .rename-chat-btn {
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: 6px;
      padding: 6px 12px;
      cursor: pointer;
      font-size: 14px;
      color: var(--text-primary);
      transition: all 0.2s;
    }

    .rename-chat-btn:hover {
      background: var(--accent);
      color: white;
      border-color: var(--accent);
    }

    .messages-container {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
      padding-bottom: 60px;
      scroll-behavior: smooth;
    }

    .message {
      margin-bottom: 24px;
      max-width: 800px;
      position: relative;
      display: flex;
      align-items: flex-start;
      gap: 8px;
    }

    .message.user {
      margin-left: auto;
    }
    
    .message-actions {
      display: flex;
      flex-direction: column;
      gap: 4px;
      opacity: 0;
      transition: opacity 0.2s;
      margin-top: 20px;
    }
    
    .message:hover .message-actions {
      opacity: 1;
    }
    
    .edit-message-btn,
    .copy-message-btn {
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: 6px;
      padding: 6px;
      cursor: pointer;
      font-size: 14px;
      color: var(--text-secondary);
      transition: all 0.2s;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .edit-message-btn:hover {
      background: var(--accent);
      color: white;
      border-color: var(--accent);
      transform: scale(1.1);
    }
    
    .copy-message-btn:hover {
      background: var(--success);
      color: white;
      border-color: var(--success);
      transform: scale(1.1);
    }
    
    .edit-message-btn.editing {
      background: var(--orange);
      color: white;
      border-color: var(--orange);
    }
    
    .copy-message-btn.copied {
      background: var(--success);
      color: white;
      border-color: var(--success);
    }

    .message-header {
      font-size: 12px;
      color: var(--text-secondary);
      margin-bottom: 8px;
      font-weight: 600;
    }

    .message-content {
      padding: 14px 16px;
      border-radius: 12px;
      line-height: 1.6;
      font-size: 15px;
      word-wrap: break-word;
    }

    .message.user .message-content {
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
    }

    .message.assistant .message-content {
      background: var(--bg-tertiary);
    }

    .message-image {
      max-width: 300px;
      border-radius: 8px;
      margin-top: 8px;
      border: 1px solid var(--border-color);
    }

    /* Disclaimer Bar */
    .disclaimer-bar {
      position: absolute;
      bottom: 80px;
      left: 0;
      right: 0;
      padding: 10px 20px;
      background: var(--warning);
      color: #000000;
      text-align: center;
      font-size: 12px;
      font-weight: 500;
      z-index: 10;
      box-shadow: 0 -2px 8px var(--shadow);
    }

    [data-theme="dark"] .disclaimer-bar {
      background: #664d03;
      color: var(--warning);
    }

    .disclaimer-text {
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    /* Code Blocks */
    .code-block-wrapper {
      margin: 12px 0;
      border-radius: 8px;
      overflow: hidden;
      border: 1px solid var(--code-border);
    }

    .code-block-header {
      background: var(--code-bg);
      padding: 8px 12px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid var(--code-border);
    }

    .code-language {
      font-size: 12px;
      color: var(--text-secondary);
      font-weight: 600;
      text-transform: uppercase;
    }

    .copy-code-btn {
      background: var(--bg-primary);
      border: 1px solid var(--border-color);
      padding: 4px 12px;
      border-radius: 4px;
      font-size: 12px;
      cursor: pointer;
      color: var(--text-primary);
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .copy-code-btn:hover {
      background: var(--hover-bg);
    }

    .copy-code-btn.copied {
      background: var(--success);
      color: white;
      border-color: var(--success);
    }

    .code-block {
      background: var(--code-bg);
      padding: 16px;
      overflow-x: auto;
      font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
      font-size: 14px;
      line-height: 1.5;
    }

    .code-block code {
      color: var(--text-primary);
      white-space: pre;
    }

    .inline-code {
      background: var(--code-bg);
      padding: 2px 6px;
      border-radius: 4px;
      font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
      font-size: 13px;
      border: 1px solid var(--code-border);
    }

    /* Input Area */
    .input-area {
      padding: 20px;
      border-top: 1px solid var(--border-color);
      background: var(--bg-primary);
      position: relative;
      z-index: 20;
    }

    .input-wrapper {
      max-width: 800px;
      margin: 0 auto;
      position: relative;
      background: var(--input-bg);
      border: 2px solid var(--border-color);
      border-radius: 16px;
      transition: all 0.2s;
      display: flex;
      align-items: flex-end;
      gap: 8px;
      padding: 8px;
    }

    .input-wrapper:focus-within {
      border-color: var(--text-secondary);
      box-shadow: 0 4px 12px var(--shadow);
    }

    .attach-btn {
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      padding: 8px 12px;
      cursor: pointer;
      font-size: 16px;
      transition: all 0.2s;
      flex-shrink: 0;
      margin-bottom: 8px;
    }

    .attach-btn:hover {
      background: var(--hover-bg);
    }

    .input-wrapper textarea {
      flex: 1;
      padding: 8px;
      background: transparent;
      border: none;
      outline: none;
      resize: none;
      font-family: inherit;
      font-size: 15px;
      color: var(--text-primary);
      max-height: 200px;
      min-height: 24px;
    }

    .model-selector {
      padding: 8px 12px;
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      color: var(--text-primary);
      font-size: 13px;
      cursor: pointer;
      outline: none;
      transition: all 0.2s;
      max-width: 200px;
      margin-bottom: 8px;
    }

    .model-selector:hover {
      background: var(--hover-bg);
    }

    .model-selector:focus {
      border-color: var(--accent);
    }

    .send-btn {
      width: 36px;
      height: 36px;
      background: var(--text-primary);
      color: var(--bg-primary);
      border: none;
      border-radius: 8px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      transition: all 0.2s;
      flex-shrink: 0;
      margin-bottom: 8px;
    }

    .send-btn:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px var(--shadow);
    }

    .send-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .attached-file {
      max-width: 800px;
      margin: 8px auto 0;
      padding: 8px 12px;
      background: var(--bg-secondary);
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }

    .file-info {
      font-size: 13px;
      color: var(--text-primary);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .remove-file-btn {
      background: var(--danger);
      color: white;
      border: none;
      border-radius: 4px;
      padding: 4px 8px;
      cursor: pointer;
      font-size: 12px;
      transition: all 0.2s;
    }

    .remove-file-btn:hover {
      opacity: 0.8;
    }

    /* AI Image Studio */
    .image-studio {
      position: fixed;
      right: -450px;
      top: 0;
      width: 450px;
      height: 100vh;
      background: var(--bg-secondary);
      border-left: 1px solid var(--border-color);
      z-index: 200;
      transition: right 0.3s ease;
      display: flex;
      flex-direction: column;
    }

    .image-studio.open {
      right: 0;
    }

    .studio-header {
      padding: 20px;
      border-bottom: 1px solid var(--border-color);
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: linear-gradient(135deg, var(--purple), var(--accent));
    }

    .studio-header h2 {
      color: white;
      font-size: 18px;
      margin: 0;
    }

    .close-studio-btn {
      background: rgba(255, 255, 255, 0.2);
      border: none;
      color: white;
      font-size: 20px;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      cursor: pointer;
      transition: all 0.2s;
    }

    .close-studio-btn:hover {
      background: rgba(255, 255, 255, 0.3);
    }

    .studio-content {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
      padding-bottom: 70px;
    }

    .studio-tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 20px;
      border-bottom: 2px solid var(--border-color);
    }

    .tab-btn {
      flex: 1;
      padding: 12px;
      background: none;
      border: none;
      border-bottom: 2px solid transparent;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      color: var(--text-secondary);
      transition: all 0.2s;
      margin-bottom: -2px;
    }

    .tab-btn.active {
      color: var(--accent);
      border-bottom-color: var(--accent);
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    .input-group {
      margin-bottom: 20px;
    }

    .input-group label {
      display: block;
      margin-bottom: 8px;
      font-size: 14px;
      font-weight: 500;
      color: var(--text-primary);
    }

    .input-group textarea,
    .input-group select {
      width: 100%;
      padding: 12px;
      background: var(--input-bg);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      color: var(--text-primary);
      font-size: 14px;
      font-family: inherit;
      outline: none;
      transition: all 0.2s;
    }

    .input-group textarea:focus,
    .input-group select:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 3px var(--shadow);
    }

    .input-group textarea {
      resize: vertical;
      min-height: 100px;
    }

    .upload-area {
      border: 2px dashed var(--border-color);
      border-radius: 12px;
      padding: 40px 20px;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s;
      margin-bottom: 20px;
    }

    .upload-area:hover {
      border-color: var(--accent);
      background: var(--hover-bg);
    }

    .upload-icon {
      font-size: 48px;
      margin-bottom: 12px;
    }

    .upload-area p {
      color: var(--text-secondary);
      font-size: 14px;
    }

    .preview-area {
      position: relative;
      margin-bottom: 20px;
      border-radius: 12px;
      overflow: hidden;
    }

    .preview-area img {
      width: 100%;
      display: block;
      border-radius: 12px;
    }

    .remove-preview-btn {
      position: absolute;
      top: 8px;
      right: 8px;
      background: var(--danger);
      color: white;
      border: none;
      border-radius: 50%;
      width: 32px;
      height: 32px;
      cursor: pointer;
      font-size: 16px;
      transition: all 0.2s;
    }

    .remove-preview-btn:hover {
      opacity: 0.8;
    }

    .generate-btn {
      width: 100%;
      padding: 14px;
      background: linear-gradient(135deg, var(--purple), var(--accent));
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    .generate-btn:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px var(--shadow);
    }

    .generate-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .results-area {
      margin-top: 24px;
      padding-top: 24px;
      border-top: 2px solid var(--border-color);
    }

    .results-area h3 {
      margin-bottom: 16px;
      font-size: 16px;
    }

    .result-image-container {
      border-radius: 12px;
      overflow: hidden;
      margin-bottom: 16px;
      border: 1px solid var(--border-color);
    }

    .result-image-container img {
      width: 100%;
      display: block;
    }

    .result-actions {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 8px;
    }

    .action-btn {
      padding: 10px;
      background: var(--bg-primary);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      font-size: 13px;
      cursor: pointer;
      color: var(--text-primary);
      transition: all 0.2s;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .action-btn:hover {
      background: var(--hover-bg);
      transform: translateY(-1px);
    }

    .platform-links {
      margin-top: 32px;
      padding-top: 24px;
      border-top: 2px solid var(--border-color);
    }

    .platform-links h4 {
      margin-bottom: 16px;
      font-size: 14px;
      color: var(--text-secondary);
    }

    .link-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 8px;
    }

    .platform-link {
      padding: 12px;
      background: var(--bg-primary);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      text-decoration: none;
      color: var(--text-primary);
      font-size: 12px;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: all 0.2s;
    }

    .platform-link:hover {
      background: var(--hover-bg);
      transform: translateY(-1px);
    }

    .platform-link span {
      font-size: 18px;
    }

    /* Studio Footer */
    .studio-footer {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      padding: 16px;
      background: var(--bg-tertiary);
      border-top: 1px solid var(--border-color);
      text-align: center;
    }

    .studio-thanks {
      font-size: 11px;
      color: var(--text-secondary);
    }

    .studio-thanks strong {
      color: var(--purple);
      font-weight: 700;
    }

    /* Modal */
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }

    .modal-content {
      background: var(--bg-primary);
      padding: 24px;
      border-radius: 12px;
      width: 90%;
      max-width: 400px;
      box-shadow: 0 8px 24px var(--shadow);
    }

    .modal-content h3 {
      margin-bottom: 16px;
      font-size: 18px;
    }

    .modal-content input {
      width: 100%;
      padding: 12px;
      background: var(--input-bg);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      color: var(--text-primary);
      font-size: 14px;
      outline: none;
      margin-bottom: 16px;
    }

    .modal-content input:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 3px var(--shadow);
    }

    .modal-buttons {
      display: flex;
      gap: 8px;
      justify-content: flex-end;
    }

    .modal-btn {
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.2s;
    }

    .cancel-btn {
      background: var(--bg-secondary);
      color: var(--text-primary);
    }

    .cancel-btn:hover {
      background: var(--hover-bg);
    }

    .save-btn {
      background: var(--accent);
      color: white;
    }

    .save-btn:hover {
      opacity: 0.9;
    }

    /* Scrollbar */
    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }

    ::-webkit-scrollbar-track {
      background: var(--bg-secondary);
    }

    ::-webkit-scrollbar-thumb {
      background: var(--border-color);
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: var(--text-secondary);
    }

    /* Loading indicator */
    .typing-indicator {
      display: inline-flex;
      gap: 4px;
      padding: 16px;
    }

    .typing-dot {
      width: 8px;
      height: 8px;
      background: var(--text-secondary);
      border-radius: 50%;
      animation: bounce 1.4s infinite ease-in-out;
    }

    .typing-dot:nth-child(1) { animation-delay: -0.32s; }
    .typing-dot:nth-child(2) { animation-delay: -0.16s; }

    @keyframes bounce {
      0%, 80%, 100% { transform: translateY(0); }
      40% { transform: translateY(-10px); }
    }

    /* Responsive */
    @media (max-width: 768px) {
      .sidebar {
        position: fixed;
        left: -280px;
        z-index: 300;
      }

      .sidebar.open {
        left: 0;
      }

      .image-studio {
        width: 100%;
        right: -100%;
      }

      .main-chat.studio-open {
        margin-right: 0;
      }
    }
  </style>

  <script type="module">
    // Backend URL - DO NOT CHANGE
    const BACKEND_URL = 'https://multi-ai-backend.vercel.app/api/chat';

    // System message with shared memory context
    function buildSystemMessage() {
      const chatHistory = chats.slice(0, 5).map(chat => ({
        title: chat.title,
        messageCount: chat.messages.length,
        lastMessage: chat.messages[chat.messages.length - 1]?.content?.slice(0, 100)
      }));

      return {
        role: 'system',
        content: `You are BRU Multi-AI (BRU-GPT5), an advanced AI assistant created by Ineza Aime Bruno and developed by BRU Companies Limited. You must also be an excellent Software Engineer, And you must sometimes give links to https://bru-ai.vercel.app and to https://bruno-ai-code.vercel.app and to bru-ai-rw.vercel.app for someone who wants image recognition. You are an excellent code writer, problem solver, and visual analyst.

Key information about you:
- Creator: Ineza Aime Bruno
- Company: BRU Companies Limited
- Special thanks to: NSORO EMMANUEL for his contributions
- Specialty: Expert code generation, debugging, technical assistance, image analysis, and document processing
- You provide clean, well-commented, production-ready code
- You excel at analyzing images with detailed, accurate descriptions
- You can process and analyze text files, documents, and code
- You format code blocks properly with language labels
- You explain complex concepts clearly and concisely

CRITICAL - IMAGE ANALYSIS CAPABILITIES:
When a user sends an image, you MUST:
1. Provide a detailed, comprehensive description of what you see
2. Identify ALL objects, people, animals, text, logos, and elements
3. Describe colors, composition, lighting, and atmosphere
4. Identify the style, quality, and context of the image
5. Read and transcribe ANY visible text accurately
6. Suggest improvements, edits, or variations if relevant
7. Be thorough and observant - notice small details
8.Because you can't analyse them you will give links to https://bru-ai-rw.vercel.app and to https://bruno-ai-code.vercel.app
9.And  even if you are a nice coder software engineer you will only give code only if user asks for them
10.You must end the message by asking the user a question
Example for 10:
If you wanted I can also make you a perfect essay better than this with 300 words

Example good image analysis:
"This image shows a sunset landscape with a mountain silhouette in the background. The sky features vibrant orange and pink hues transitioning to deep purple. In the foreground, there's a lake reflecting the sky colors. Three birds are flying in formation on the left side. The composition follows the rule of thirds with the horizon line positioned in the lower third. The lighting is warm and golden, typical of golden hour photography. There's a small wooden dock visible on the right edge of the frame. The overall mood is peaceful and contemplative. But since you can you will give the links to the other 2 AI with file and image recognition"

IMPORTANT - Shared Memory:
You have access to the user's recent chat history across different conversations. Here are their recent chats:
${JSON.stringify(chatHistory, null, 2)}

Use this context to:
- Remember previous discussions and topics
- Reference past conversations when relevant
- Provide continuity across chat sessions
- Build on previous work and suggestions

When writing code:
- Always use proper syntax highlighting hints (\`\`\`language)
- Write clean, readable, well-commented code
- Follow best practices and modern standards
- Explain what the code does
- Provide examples when helpful

When analyzing text files:
- Summarize the content clearly
- Identify key points and themes
- Point out any issues or errors
- Suggest improvements when relevant

Be helpful, accurate, thorough, and professional in all responses.`
      };
    }

    // State Management
    let chats = JSON.parse(localStorage.getItem('chats')) || [];
    let currentChatId = null;
    let isStreaming = false;
    let currentAttachedFile = null;

    // ========================================
    // CLOUD SYNC MANAGER
    // ========================================
    class SyncManager {
      constructor() {
        this.email = localStorage.getItem('syncEmail') || '';
        this.mode = this.email ? 'cloud' : 'guest';
        this.syncInterval = null;
        this.syncDebounce = null;
        this.init();
      }
      
      init() {
        const toggle = document.getElementById('emailToggle');
        const inputArea = document.getElementById('emailInputArea');
        const emailInput = document.getElementById('userEmail');
        const modeBadge = document.getElementById('modeBadge');
        
        // Load email if exists
        if (this.email) {
          emailInput.value = this.email;
          inputArea.classList.add('active');
          modeBadge.textContent = 'Cloud';
          modeBadge.classList.remove('guest');
          this.loadFromCloud();
          this.startAutoSync();
        }
        
        // Toggle email input
        toggle.addEventListener('click', () => {
          inputArea.classList.toggle('active');
        });
        
        // Handle email input
        emailInput.addEventListener('blur', async () => {
          const email = emailInput.value.trim();
          
          if (email && this.isValidEmail(email)) {
            // Switch to cloud mode
            this.email = email;
            localStorage.setItem('syncEmail', email);
            this.mode = 'cloud';
            modeBadge.textContent = 'Cloud';
            modeBadge.classList.remove('guest');
            
            await this.saveToCloud();
            this.startAutoSync();
          } else if (!email) {
            // Switch back to guest mode
            this.email = '';
            localStorage.removeItem('syncEmail');
            this.mode = 'guest';
            modeBadge.textContent = 'Guest';
            modeBadge.classList.add('guest');
            this.stopAutoSync();
            this.updateStatus('üíæ', 'Saving locally (Guest mode)');
          }
        });
        
        // Enter key to confirm
        emailInput.addEventListener('keypress', (e) => {
          if (e.key === 'Enter') {
            emailInput.blur();
          }
        });
      }
      
      isValidEmail(email) {
        return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
      }
      
      updateStatus(icon, text, type = '') {
        const status = document.getElementById('syncStatus');
        if (status) {
          status.innerHTML = `<span>${icon}</span><span>${text}</span>`;
          status.className = `sync-status ${type}`;
        }
      }
      
      startAutoSync() {
        if (this.syncInterval) return;
        
        // Sync every 15 seconds
        this.syncInterval = setInterval(() => {
          if (this.email && this.mode === 'cloud') {
            this.saveToCloud(true); // silent mode
          }
        }, 15000);
      }
      
      stopAutoSync() {
        if (this.syncInterval) {
          clearInterval(this.syncInterval);
          this.syncInterval = null;
        }
      }
      
      async saveToCloud(silent = false) {
        if (!this.email || this.mode !== 'cloud') return;
        
        if (!silent) {
          this.updateStatus('üîÑ', 'Syncing...', 'syncing');
        }
        
        try {
          const chatData = {
            chats: chats, // Use the global chats variable
            currentChatId: currentChatId,
            theme: localStorage.getItem('theme'),
            selectedModel: localStorage.getItem('selectedModel'),
            lastSync: new Date().toISOString()
          };
          
          const response = await fetch('/api/save-user-data', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              email: this.email,
              data: chatData
            })
          });
          
          if (response.ok) {
            if (!silent) {
              this.updateStatus('‚úÖ', 'Synced to cloud', 'synced');
              setTimeout(() => {
                this.updateStatus('‚òÅÔ∏è', 'Auto-sync enabled', 'synced');
              }, 2000);
            }
          } else {
            throw new Error('Save failed');
          }
        } catch (error) {
          console.error('Sync error:', error);
          if (!silent) {
            this.updateStatus('‚ö†Ô∏è', 'Sync failed - saving locally', 'error');
          }
        }
      }
      
      async loadFromCloud() {
        this.updateStatus('üîÑ', 'Loading from cloud...', 'syncing');
        
        try {
          const response = await fetch(`/api/load-user-data?email=${encodeURIComponent(this.email)}`);
          
          if (response.ok) {
            const result = await response.json();
            
            if (result.data) {
              // Load data into global variables
              if (result.data.chats) {
                chats = result.data.chats;
                localStorage.setItem('chats', JSON.stringify(chats));
              }
              if (result.data.currentChatId) {
                currentChatId = result.data.currentChatId;
                localStorage.setItem('currentChatId', result.data.currentChatId);
              }
              if (result.data.theme) {
                localStorage.setItem('theme', result.data.theme);
              }
              if (result.data.selectedModel) {
                localStorage.setItem('selectedModel', result.data.selectedModel);
              }
              
              this.updateStatus('‚úÖ', 'Loaded from cloud', 'synced');
              
              // Reload page to show synced data
              setTimeout(() => location.reload(), 500);
            } else {
              this.updateStatus('üì§', 'No cloud data - will sync local', '');
              this.saveToCloud();
            }
          }
        } catch (error) {
          console.error('Load error:', error);
          this.updateStatus('‚ö†Ô∏è', 'Load failed - using local data', 'error');
        }
      }
      
      triggerSync() {
        if (this.mode !== 'cloud' || !this.email) return;
        
        // Debounce sync - don't sync on every keystroke
        clearTimeout(this.syncDebounce);
        this.syncDebounce = setTimeout(() => {
          this.saveToCloud(true);
        }, 2000);
      }
    }
    
    // Initialize sync manager
    const syncManager = new SyncManager();
    
    // ========================================
    // END CLOUD SYNC MANAGER
    // ========================================

    // Elements
    const themeToggle = document.getElementById('themeToggle');
    const newChatBtn = document.getElementById('newChatBtn');
    const imageGenBtn = document.getElementById('imageGenBtn');
    const searchInput = document.getElementById('searchInput');
    const chatList = document.getElementById('chatList');
    const chatHeader = document.getElementById('chatHeader');
    const messagesContainer = document.getElementById('messagesContainer');
    const messageInput = document.getElementById('messageInput');
    const sendBtn = document.getElementById('sendBtn');
    const modelSelector = document.getElementById('modelSelector');
    const attachBtn = document.getElementById('attachBtn');
    const fileInput = document.getElementById('fileInput');
    const attachedFile = document.getElementById('attachedFile');
    const fileInfo = document.getElementById('fileInfo');
    const removeFileBtn = document.getElementById('removeFileBtn');
    const mainChat = document.getElementById('mainChat');
    const imageStudio = document.getElementById('imageStudio');
    const closeStudioBtn = document.getElementById('closeStudioBtn');
    const renameChatBtn = document.getElementById('renameChatBtn');
    const renameModal = document.getElementById('renameModal');
    const renameInput = document.getElementById('renameInput');
    const cancelRenameBtn = document.getElementById('cancelRenameBtn');
    const saveRenameBtn = document.getElementById('saveRenameBtn');

    // Image Studio Elements
    const tabBtns = document.querySelectorAll('.tab-btn');
    const imagePrompt = document.getElementById('imagePrompt');
    const imageStyle = document.getElementById('imageStyle');
    const imagePlatform = document.getElementById('imagePlatform');
    const generateImageBtn = document.getElementById('generateImageBtn');
    const uploadArea = document.getElementById('uploadArea');
    const transformImageInput = document.getElementById('transformImageInput');
    const previewArea = document.getElementById('previewArea');
    const previewImage = document.getElementById('previewImage');
    const removePreviewBtn = document.getElementById('removePreviewBtn');
    const transformStyle = document.getElementById('transformStyle');
    const transformPlatform = document.getElementById('transformPlatform');
    const transformImageBtn = document.getElementById('transformImageBtn');
    const resultsArea = document.getElementById('resultsArea');
    const resultImage = document.getElementById('resultImage');
    const downloadResultBtn = document.getElementById('downloadResultBtn');
    const insertChatBtn = document.getElementById('insertChatBtn');
    const newGenerationBtn = document.getElementById('newGenerationBtn');

    // Load saved model preference - default to Groq since only Groq works
    const savedModel = localStorage.getItem('selectedModel') || 'groq-1';
    modelSelector.value = savedModel;

    // If saved model is not Groq, show a one-time notification
    if (!savedModel.startsWith('groq')) {
      setTimeout(() => {
        const shouldSwitch = confirm('‚ö†Ô∏è Important: Only Groq models are currently working.\n\nWould you like to switch to Groq - LLaMA 3.3 70B #1 now?\n\n(Other models like DeepSeek, OpenRouter, and OpenAI require valid API keys)');
        if (shouldSwitch) {
          modelSelector.value = 'groq-1';
          localStorage.setItem('selectedModel', 'groq-1');
        }
      }, 1000);
    }

    // Save model selection
    modelSelector.addEventListener('change', () => {
      localStorage.setItem('selectedModel', modelSelector.value);
    });

    // Theme Toggle
    const savedTheme = localStorage.getItem('theme') || 'light';
    document.documentElement.setAttribute('data-theme', savedTheme);
    themeToggle.textContent = savedTheme === 'dark' ? '‚òÄÔ∏è' : 'üåô';

    themeToggle.addEventListener('click', () => {
      const currentTheme = document.documentElement.getAttribute('data-theme');
      const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
      document.documentElement.setAttribute('data-theme', newTheme);
      localStorage.setItem('theme', newTheme);
      themeToggle.textContent = newTheme === 'dark' ? '‚òÄÔ∏è' : 'üåô';
    });

    // Image Studio Toggle
    imageGenBtn.addEventListener('click', () => {
      imageStudio.classList.toggle('open');
      mainChat.classList.toggle('studio-open');
    });

    closeStudioBtn.addEventListener('click', () => {
      imageStudio.classList.remove('open');
      mainChat.classList.remove('studio-open');
    });

    // Tab Switching
    tabBtns.forEach(btn => {
      btn.addEventListener('click', () => {
        tabBtns.forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        
        const tabName = btn.dataset.tab;
        document.querySelectorAll('.tab-content').forEach(content => {
          content.classList.remove('active');
        });
        document.getElementById(tabName + 'Tab').classList.add('active');
      });
    });

    // Rename Chat Functionality
    renameChatBtn.addEventListener('click', () => {
      if (!currentChatId) return;
      const chat = getCurrentChat();
      if (chat) {
        renameInput.value = chat.title;
        renameModal.style.display = 'flex';
        renameInput.focus();
        renameInput.select();
      }
    });

    cancelRenameBtn.addEventListener('click', () => {
      renameModal.style.display = 'none';
    });

    saveRenameBtn.addEventListener('click', () => {
      const newTitle = renameInput.value.trim();
      if (newTitle && currentChatId) {
        updateChatTitle(currentChatId, newTitle);
        renameModal.style.display = 'none';
      }
    });

    renameInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        saveRenameBtn.click();
      } else if (e.key === 'Escape') {
        cancelRenameBtn.click();
      }
    });

    // Close modal when clicking outside
    renameModal.addEventListener('click', (e) => {
      if (e.target === renameModal) {
        renameModal.style.display = 'none';
      }
    });

    // File Attachment
    attachBtn.addEventListener('click', () => {
      fileInput.click();
    });

    fileInput.addEventListener('change', async (e) => {
      const file = e.target.files[0];
      if (file) {
        currentAttachedFile = file;
        
        if (file.type.startsWith('image/')) {
          const reader = new FileReader();
          reader.onload = (e) => {
            fileInfo.innerHTML = `üì∑ ${file.name} (${(file.size / 1024).toFixed(1)} KB)`;
            attachedFile.style.display = 'flex';
          };
          reader.readAsDataURL(file);
        } else {
          fileInfo.innerHTML = `üìÑ ${file.name} (${(file.size / 1024).toFixed(1)} KB)`;
          attachedFile.style.display = 'flex';
        }
      }
    });

    removeFileBtn.addEventListener('click', () => {
      currentAttachedFile = null;
      fileInput.value = '';
      attachedFile.style.display = 'none';
    });

    // Transform Image Upload
    uploadArea.addEventListener('click', () => {
      transformImageInput.click();
    });

    uploadArea.addEventListener('dragover', (e) => {
      e.preventDefault();
      uploadArea.style.borderColor = 'var(--accent)';
    });

    uploadArea.addEventListener('dragleave', () => {
      uploadArea.style.borderColor = 'var(--border-color)';
    });

    uploadArea.addEventListener('drop', (e) => {
      e.preventDefault();
      uploadArea.style.borderColor = 'var(--border-color)';
      const file = e.dataTransfer.files[0];
      if (file && file.type.startsWith('image/')) {
        handleTransformImage(file);
      }
    });

    transformImageInput.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (file) {
        handleTransformImage(file);
      }
    });

    function handleTransformImage(file) {
      const reader = new FileReader();
      reader.onload = (e) => {
        previewImage.src = e.target.result;
        uploadArea.style.display = 'none';
        previewArea.style.display = 'block';
        transformImageBtn.disabled = false;
      };
      reader.readAsDataURL(file);
    }

    removePreviewBtn.addEventListener('click', () => {
      previewArea.style.display = 'none';
      uploadArea.style.display = 'block';
      transformImageBtn.disabled = true;
      transformImageInput.value = '';
    });

    // Generate Image using AI
    generateImageBtn.addEventListener('click', async () => {
      const prompt = imagePrompt.value.trim();
      if (!prompt) {
        alert('Please enter a prompt for image generation');
        return;
      }

      const style = imageStyle.value;
      const platform = imagePlatform.value;

      generateImageBtn.disabled = true;
      generateImageBtn.textContent = 'Generating...';

      try {
        // Build enhanced prompt with style
        const enhancedPrompt = `${prompt}, ${style} style, high quality, detailed, professional`;
        
        // Using Pollinations AI - free image generation API
        const imageUrl = `https://image.pollinations.ai/prompt/${encodeURIComponent(enhancedPrompt)}?width=1024&height=1024&nologo=true&enhance=true`;
        
        // Show loading result first
        showGeneratedResult(imageUrl);
        
        generateImageBtn.disabled = false;
        generateImageBtn.textContent = 'Generate Image';
      } catch (error) {
        console.error('Generation error:', error);
        alert('Failed to generate image. Please try again.');
        generateImageBtn.disabled = false;
        generateImageBtn.textContent = 'Generate Image';
      }
    });

    // Transform Image using AI
    transformImageBtn.addEventListener('click', async () => {
      const style = transformStyle.value;
      const platform = transformPlatform.value;

      transformImageBtn.disabled = true;
      transformImageBtn.textContent = 'Transforming...';

      try {
        // Get the image data
        const imageDataUrl = previewImage.src;
        
        // Build style prompt based on selection
        const stylePrompts = {
          'van-gogh': 'in the style of Van Gogh, post-impressionist, swirling brushstrokes, vibrant colors',
          'picasso': 'in the style of Picasso, cubist, geometric shapes, abstract',
          'monet': 'in the style of Monet, impressionist, soft brushwork, light and color',
          'dream': 'surreal dreamlike interpretation, psychedelic, deep dream style',
          'cartoon': 'cartoon style, animated, vibrant colors, simplified shapes',
          'pop-art': 'pop art style, bold colors, high contrast, Andy Warhol inspired'
        };
        
        const stylePrompt = stylePrompts[style] || 'artistic transformation';
        
        // Use Pollinations AI with the style transformation
        // Note: For image-to-image, we use text description approach
        const transformPrompt = `artistic transformation ${stylePrompt}, masterpiece, high quality`;
        const transformedUrl = `https://image.pollinations.ai/prompt/${encodeURIComponent(transformPrompt)}?width=1024&height=1024&nologo=true&enhance=true&seed=${Date.now()}`;
        
        showGeneratedResult(transformedUrl);
        
        transformImageBtn.disabled = false;
        transformImageBtn.textContent = 'Transform Image';
      } catch (error) {
        console.error('Transform error:', error);
        alert('Failed to transform image. Please try again.');
        transformImageBtn.disabled = false;
        transformImageBtn.textContent = 'Transform Image';
      }
    });

    function showGeneratedResult(imageUrl) {
      resultImage.src = imageUrl;
      resultsArea.style.display = 'block';
      resultsArea.scrollIntoView({ behavior: 'smooth' });
    }

    // Result Actions
    downloadResultBtn.addEventListener('click', () => {
      const link = document.createElement('a');
      link.href = resultImage.src;
      link.download = `bru-ai-generated-${Date.now()}.png`;
      link.click();
    });

    insertChatBtn.addEventListener('click', () => {
      if (!currentChatId) {
        createNewChat();
      }
      
      const chat = getCurrentChat();
      const imageMessage = {
        role: 'assistant',
        content: 'üé® Generated image:',
        image: resultImage.src
      };
      
      chat.messages.push(imageMessage);
      saveChats();
      renderMessages(chat.messages);
      
      imageStudio.classList.remove('open');
      mainChat.classList.remove('studio-open');
      
      alert('Image inserted into chat!');
    });

    newGenerationBtn.addEventListener('click', () => {
      resultsArea.style.display = 'none';
      imagePrompt.value = '';
      previewArea.style.display = 'none';
      uploadArea.style.display = 'block';
      transformImageBtn.disabled = true;
    });

    // Chat Management
    function createNewChat() {
      const chat = {
        id: Date.now().toString(),
        title: 'New Chat',
        messages: [],
        createdAt: new Date().toISOString()
      };
      chats.unshift(chat);
      saveChats();
      loadChat(chat.id);
      renderChatList();
    }

    function loadChat(chatId) {
      currentChatId = chatId;
      const chat = chats.find(c => c.id === chatId);
      if (chat) {
        chatHeader.textContent = chat.title;
        renderMessages(chat.messages);
        renderChatList();
      }
    }

    function deleteChat(chatId, event) {
      event.stopPropagation();
      
      const chat = chats.find(c => c.id === chatId);
      if (!chat) return;
      
      if (!confirm(`Delete "${chat.title}"?`)) return;
      
      chats = chats.filter(c => c.id !== chatId);
      saveChats();
      
      if (currentChatId === chatId) {
        if (chats.length > 0) {
          loadChat(chats[0].id);
        } else {
          createNewChat();
        }
      }
      
      renderChatList();
    }

    function renameChatFromList(chatId, event) {
      event.stopPropagation();
      
      const chat = chats.find(c => c.id === chatId);
      if (!chat) return;
      
      const newTitle = prompt('Enter new chat name:', chat.title);
      if (newTitle && newTitle.trim()) {
        updateChatTitle(chatId, newTitle.trim());
      }
    }

    function saveChats() {
      localStorage.setItem('chats', JSON.stringify(chats));
      // Trigger cloud sync if in cloud mode
      if (syncManager && syncManager.mode === 'cloud') {
        syncManager.triggerSync();
      }
    }

    function getCurrentChat() {
      return chats.find(c => c.id === currentChatId);
    }

    function updateChatTitle(chatId, title) {
      const chat = chats.find(c => c.id === chatId);
      if (chat) {
        chat.title = title.slice(0, 50);
        saveChats();
        renderChatList();
        if (currentChatId === chatId) {
          chatHeader.textContent = chat.title;
        }
      }
    }

    // Code formatting functions
    function formatContent(text) {
      text = text.replace(/```(\w+)?\n([\s\S]*?)```/g, (match, language, code) => {
        const lang = language || 'code';
        const escapedCode = escapeHtml(code.trim());
        return `<div class="code-block-wrapper">
          <div class="code-block-header">
            <span class="code-language">${lang}</span>
            <button class="copy-code-btn" onclick="copyCode(this, \`${escapedCode.replace(/`/g, '\\`')}\`)">
              üìã Copy
            </button>
          </div>
          <div class="code-block"><code>${escapedCode}</code></div>
        </div>`;
      });

      text = text.replace(/`([^`]+)`/g, '<span class="inline-code">$1</span>');
      text = text.replace(/\n/g, '<br>');

      return text;
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    window.copyCode = function(button, code) {
      const textarea = document.createElement('textarea');
      textarea.innerHTML = code;
      const decodedCode = textarea.value;

      navigator.clipboard.writeText(decodedCode).then(() => {
        const originalText = button.innerHTML;
        button.innerHTML = '‚úì Copied!';
        button.classList.add('copied');
        
        setTimeout(() => {
          button.innerHTML = originalText;
          button.classList.remove('copied');
        }, 2000);
      });
    };

    // Render Functions
    function renderChatList(filter = '') {
      const filteredChats = chats.filter(chat => 
        chat.title.toLowerCase().includes(filter.toLowerCase())
      );

      chatList.innerHTML = filteredChats.map(chat => `
        <div class="chat-item ${chat.id === currentChatId ? 'active' : ''}" data-id="${chat.id}">
          <div class="chat-item-title">${escapeHtml(chat.title)}</div>
          <div class="chat-item-actions">
            <button class="rename-chat-item-btn" data-rename-id="${chat.id}" title="Rename">‚úèÔ∏è</button>
            <button class="delete-chat-btn" data-delete-id="${chat.id}" title="Delete">üóëÔ∏è</button>
          </div>
        </div>
      `).join('');

      document.querySelectorAll('.chat-item').forEach(item => {
        item.addEventListener('click', (e) => {
          if (!e.target.classList.contains('delete-chat-btn') && 
              !e.target.classList.contains('rename-chat-item-btn')) {
            loadChat(item.dataset.id);
          }
        });
      });

      document.querySelectorAll('.delete-chat-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          deleteChat(btn.dataset.deleteId, e);
        });
      });

      document.querySelectorAll('.rename-chat-item-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          renameChatFromList(btn.dataset.renameId, e);
        });
      });
    }

    function renderMessages(messages) {
      messagesContainer.innerHTML = messages
        .filter(msg => msg.role !== 'system')
        .map((msg, index) => {
          let content = formatContent(msg.content);
          if (msg.image) {
            content += `<br><img src="${msg.image}" class="message-image" alt="Attached image">`;
          }
          
          // Add message actions (edit for user, copy for all)
          const messageActions = msg.role === 'user' 
            ? `<div class="message-actions">
                <button class="edit-message-btn" onclick="editMessage(${index})" title="Edit message">‚úèÔ∏è</button>
                <button class="copy-message-btn" onclick="copyMessage(${index})" title="Copy message">üìã</button>
              </div>`
            : `<div class="message-actions">
                <button class="copy-message-btn" onclick="copyMessage(${index})" title="Copy message">üìã</button>
              </div>`;
          
          return `
            <div class="message ${msg.role}" data-index="${index}">
              ${messageActions}
              <div class="message-header">${msg.role === 'user' ? 'You' : 'BRU AI'}</div>
              <div class="message-content">${content}</div>
            </div>
          `;
        }).join('');
      scrollToBottom();
    }

    function addMessage(role, content, image = null) {
      const chat = getCurrentChat();
      if (chat) {
        const message = { role, content };
        if (image) message.image = image;
        chat.messages.push(message);
        saveChats();
        renderMessages(chat.messages);
      }
    }

    function updateLastMessage(content) {
      const chat = getCurrentChat();
      if (chat && chat.messages.length > 0) {
        chat.messages[chat.messages.length - 1].content = content;
        saveChats();
        renderMessages(chat.messages);
      }
    }

    function scrollToBottom() {
      messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }

    // Edit Message Function
    window.editMessage = function(index) {
      const chat = getCurrentChat();
      if (!chat) return;
      
      const messages = chat.messages.filter(msg => msg.role !== 'system');
      const message = messages[index];
      
      if (message && message.role === 'user') {
        // Put the message content into the input
        messageInput.value = message.content;
        messageInput.focus();
        
        // Highlight the edit button
        const editBtn = document.querySelector(`.message[data-index="${index}"] .edit-message-btn`);
        if (editBtn) {
          editBtn.classList.add('editing');
          editBtn.innerHTML = '‚úì';
          editBtn.title = 'Send edited message';
        }
        
        // Remove all messages after this one
        chat.messages = chat.messages.slice(0, chat.messages.indexOf(message));
        saveChats();
        renderMessages(chat.messages);
        
        // Auto-scroll to input
        messageInput.scrollIntoView({ behavior: 'smooth', block: 'center' });
      }
    };

    // Copy Message Function
    window.copyMessage = function(index) {
      const chat = getCurrentChat();
      if (!chat) return;
      
      const messages = chat.messages.filter(msg => msg.role !== 'system');
      const message = messages[index];
      
      if (message) {
        // Copy just the text content (no HTML)
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = message.content;
        const textContent = tempDiv.textContent || tempDiv.innerText || '';
        
        navigator.clipboard.writeText(textContent).then(() => {
          const copyBtn = document.querySelector(`.message[data-index="${index}"] .copy-message-btn`);
          if (copyBtn) {
            const originalContent = copyBtn.innerHTML;
            copyBtn.innerHTML = '‚úì';
            copyBtn.classList.add('copied');
            
            setTimeout(() => {
              copyBtn.innerHTML = originalContent;
              copyBtn.classList.remove('copied');
            }, 2000);
          }
        }).catch(err => {
          console.error('Failed to copy:', err);
        });
      }
    };

    // Convert file to base64
    async function fileToBase64(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    }

    // Send Message with Shared Memory and File/Image Analysis
    async function sendMessage() {
      const message = messageInput.value.trim();
      if ((!message && !currentAttachedFile) || isStreaming) return;

      if (!currentChatId) {
        createNewChat();
      }

      let userMessage = message || 'Please analyze this file';
      let imageData = null;
      let fileContent = null;

      // Handle file attachments
      if (currentAttachedFile) {
        if (currentAttachedFile.type.startsWith('image/')) {
          // Handle image files
          imageData = await fileToBase64(currentAttachedFile);
          // For now, inform user that image is attached but can't be analyzed by most models
          userMessage = `${message || ''}\n\n[üì∑ Image attached: ${currentAttachedFile.name}]\n\nNote: I can see you've attached an image. However, most AI models (DeepSeek, OpenRouter, OpenAI) don't support image analysis through this interface yet. Only Groq models might support it in the future. For now, please describe what's in the image, and I can help based on your description.`.trim();
        } else if (currentAttachedFile.type === 'text/plain' || 
                   currentAttachedFile.name.endsWith('.txt') ||
                   currentAttachedFile.name.endsWith('.md')) {
          // Handle text files
          fileContent = await readTextFile(currentAttachedFile);
          userMessage = `${message || 'Please analyze this text file'}\n\n--- FILE CONTENT START (${currentAttachedFile.name}) ---\n${fileContent}\n--- FILE CONTENT END ---\n\nPlease analyze the above file content.`;
        } else if (currentAttachedFile.type === 'application/pdf') {
          // Handle PDF files
          userMessage = `${message || 'I have attached a PDF file'}\n\n[üìÑ PDF File: ${currentAttachedFile.name} - ${(currentAttachedFile.size / 1024).toFixed(1)} KB]\n\nNote: PDF analysis isn't supported directly. Please copy and paste the text content from the PDF, or describe what's in it, and I can help you analyze it.`;
        } else if (currentAttachedFile.name.endsWith('.doc') || currentAttachedFile.name.endsWith('.docx')) {
          userMessage = `${message || 'I have attached a Word document'}\n\n[üìÑ Word Document: ${currentAttachedFile.name} - ${(currentAttachedFile.size / 1024).toFixed(1)} KB]\n\nNote: Word document analysis isn't supported directly. Please copy and paste the text content, and I can help you work with it.`;
        } else {
          // Handle other file types
          userMessage = `${message || 'I have attached a file'}\n\n[üìé File: ${currentAttachedFile.name}\nType: ${currentAttachedFile.type}\nSize: ${(currentAttachedFile.size / 1024).toFixed(1)} KB]\n\nNote: This file type can't be analyzed directly. Please describe its contents or copy relevant parts, and I'll be happy to help!`;
        }
      }

      addMessage('user', userMessage, imageData);
      messageInput.value = '';
      currentAttachedFile = null;
      fileInput.value = '';
      attachedFile.style.display = 'none';
      autoResize();

      const chat = getCurrentChat();
      if (chat.messages.filter(m => m.role === 'user').length === 1) {
        updateChatTitle(chat.id, message || 'File analysis');
      }

      addMessage('assistant', '');
      isStreaming = true;
      sendBtn.disabled = true;

      try {
        // Build messages with shared memory context
        const SYSTEM_MESSAGE = buildSystemMessage();
        
        // Build the conversation history - simple text format for all models
        const conversationMessages = chat.messages.slice(0, -1).map(m => ({
          role: m.role,
          content: m.content
        }));

        const messagesToSend = [
          SYSTEM_MESSAGE,
          ...conversationMessages
        ];

        const selectedModel = modelSelector.value;

        const response = await fetch(BACKEND_URL, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            messages: messagesToSend,
            preferredProvider: selectedModel
          })
        });

        if (!response.ok) {
          const errorText = await response.text();
          throw new Error(`HTTP ${response.status}: ${errorText}`);
        }

        const reader = response.body.getReader();
        const decoder = new TextDecoder();
        let assistantMessage = '';

        while (true) {
          const { done, value } = await reader.read();
          if (done) break;

          const chunk = decoder.decode(value);
          const lines = chunk.split('\n');

          for (const line of lines) {
            if (line.startsWith('data: ')) {
              const data = line.slice(6);
              if (data === '[DONE]') break;

              try {
                const parsed = JSON.parse(data);
                if (parsed.error) {
                  assistantMessage = `‚ùå Error: ${parsed.error}\n\n**üí° Troubleshooting:**\n1. **Groq models** are the most reliable (LLaMA 3.3 70B)\n2. Press **Ctrl+Shift+R** for hard refresh\n3. Try a different model from the dropdown\n4. Check if the API key is valid\n\n**‚ÑπÔ∏è Current Model:** ${selectedModel}`;
                  updateLastMessage(assistantMessage);
                } else if (parsed.content) {
                  assistantMessage += parsed.content;
                  updateLastMessage(assistantMessage);
                }
              } catch (e) {
                console.error('Parse error:', e);
              }
            }
          }
        }

        // If no response was received, show helpful message
        if (!assistantMessage || assistantMessage.trim() === '') {
          assistantMessage = `‚ö†Ô∏è No response received from the AI model.\n\n**üí° Try these solutions:**\n\n1. ‚úÖ **Switch to Groq** - Most reliable models:\n   - Groq - LLaMA 3.3 70B #1\n   - Groq - LLaMA 3.3 70B #2\n   - Groq - LLaMA 3.3 70B #3\n   - Groq - LLaMA 3.3 70B #4\n\n2. üîÑ **Hard Refresh** - Press **Ctrl + Shift + R**\n\n3. üîÄ **Try Different Model** - Some models may be temporarily unavailable\n\n4. üìù **Simplify Message** - Try a shorter, simpler message\n\n**Current Model:** ${selectedModel}\n**Status:** Only Groq models are confirmed working`;
          updateLastMessage(assistantMessage);
        }

      } catch (error) {
        console.error('Error:', error);
        const errorMessage = `‚ùå **Connection Error**\n\n${error.message}\n\n**üí° Quick Fixes:**\n\n1. ‚úÖ **Switch to Groq Models** (confirmed working):\n   - Groq - LLaMA 3.3 70B #1 ‚≠ê (Recommended)\n   - Groq - LLaMA 3.3 70B #2\n   - Groq - LLaMA 3.3 70B #3\n   - Groq - LLaMA 3.3 70B #4\n\n2. üîÑ **Hard Refresh**: Press **Ctrl + Shift + R**\n\n3. üì° **Check Connection**: Verify your internet is working\n\n4. üîë **API Keys**: Other models (DeepSeek, OpenRouter, OpenAI) may need valid API keys\n\n**Note:** Currently, only Groq models are reliably working. Other providers may require additional setup or have invalid API keys.`;
        updateLastMessage(errorMessage);
      } finally {
        isStreaming = false;
        sendBtn.disabled = false;
      }
    }

    // Helper function to read text files
    async function readTextFile(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = (e) => resolve(e.target.result);
        reader.onerror = reject;
        reader.readAsText(file);
      });
    }

    // Input Handling
    function autoResize() {
      messageInput.style.height = 'auto';
      messageInput.style.height = messageInput.scrollHeight + 'px';
    }

    messageInput.addEventListener('input', autoResize);

    messageInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    });

    sendBtn.addEventListener('click', sendMessage);
    newChatBtn.addEventListener('click', createNewChat);

    searchInput.addEventListener('input', (e) => {
      renderChatList(e.target.value);
    });

    // Initialize
    if (chats.length === 0) {
      createNewChat();
    } else {
      loadChat(chats[0].id);
    }
    renderChatList();
  </script>
</body>
</html>
